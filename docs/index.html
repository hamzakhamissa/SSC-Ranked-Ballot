<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ranked Ballot Calculator (Static)</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', Arial, sans-serif; margin: 2rem; }
      .card { max-width: 720px; margin: 0 auto; padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
      h1 { font-size: 1.5rem; margin: 0 0 1rem; }
      form { display: grid; gap: 0.75rem; }
      label { font-weight: 600; }
      input[type="number"], input[type="file"], input[type="url"] { padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 8px; }
      button { padding: 0.6rem 0.9rem; border-radius: 8px; border: 0; background: #111827; color: white; cursor: pointer; }
      table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
      th, td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
      th { background: #f9fafb; }
      .muted { color: #6b7280; font-size: 0.9rem; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Ranked Ballot Calculator</h1>
      <form id="uploadForm">
        <div>
          <label for="csv">CSV file</label><br>
          <input type="file" id="csv" name="csv" accept=".csv" required>
        </div>
        <div>
          <label for="top">Top X to display</label><br>
          <input type="number" id="top" name="top" min="1" value="5" required>
        </div>
        <div>
          <button type="submit">Calculate</button>
        </div>
        <p class="muted">Runs entirely in your browser. No server/API required.</p>
      </form>

      <div id="results" style="display:none">
        <h2>Results</h2>
        <p id="meta"></p>
        <table>
          <thead>
            <tr><th>Rank</th><th>Candidate</th><th>Score</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
    <script>
      function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsText(file);
        });
      }

      function extractBallotsFromCsv(csvText) {
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        const headers = parsed.meta.fields || [];
        const rankHeaders = headers.filter(h => /^\s*Rank\s+\d+\s*$/i.test(h)).sort((a, b) => {
          const ai = parseInt(a.replace(/[^0-9]/g, ''), 10) || 9999;
          const bi = parseInt(b.replace(/[^0-9]/g, ''), 10) || 9999;
          return ai - bi;
        });
        const ballots = [];
        for (const row of parsed.data) {
          const choices = [];
          for (const h of rankHeaders) {
            const value = String(row[h] || '').trim();
            if (value) choices.push(value);
          }
          if (choices.length > 0) ballots.push(choices);
        }
        return ballots;
      }

      function computeBordaScores(ballots) {
        const scores = new Map();
        for (const ranked of ballots) {
          const k = ranked.length;
          ranked.forEach((candidate, idx) => {
            const points = k - idx;
            scores.set(candidate, (scores.get(candidate) || 0) + points);
          });
        }
        return scores;
      }

      function topX(scores, x) {
        const arr = Array.from(scores.entries());
        arr.sort((a, b) => {
          if (b[1] !== a[1]) return b[1] - a[1];
          return a[0].localeCompare(b[0]);
        });
        return arr.slice(0, x);
      }

      const form = document.getElementById('uploadForm');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('csv').files[0];
        const top = parseInt(document.getElementById('top').value, 10) || 5;
        if (!file) return;

        const text = await readFileAsText(file);
        const ballots = extractBallotsFromCsv(text);
        const scores = computeBordaScores(ballots);
        const winners = topX(scores, top);

        document.getElementById('meta').textContent = `Ballots: ${ballots.length} | Candidates: ${scores.size}`;
        const rowsTarget = document.getElementById('rows');
        rowsTarget.innerHTML = '';
        winners.forEach(([name, score], idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${idx + 1}</td><td>${name}</td><td>${score}</td>`;
          rowsTarget.appendChild(tr);
        });
        document.getElementById('results').style.display = 'block';
      });
    </script>
  </body>
  </html>


